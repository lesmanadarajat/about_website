{% extends "base.html" %}

{% block title %}Admin - Sistem Raport{% endblock %}

{% block content %}
<div class="admin-header">
    <h1><i class="fas fa-cog"></i> Dashboard Admin</h1>
    <p>Kelola data siswa dan nilai raport</p>
</div>

<div class="admin-actions">
    <a href="{{ url_for('tambah') }}" class="btn-success">
        <i class="fas fa-user-plus"></i> Tambah Siswa Baru
    </a>
    <a href="{{ url_for('index') }}" class="btn-secondary">
        <i class="fas fa-eye"></i> Lihat Mode User
    </a>
</div>

<div class="table-container">
    <h2><i class="fas fa-users"></i> Daftar Siswa</h2>
    
    {% if siswa_list %}
        <table class="modern-table">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Foto</th>
                    <th>Absen</th>
                    <th>Nama</th>
                    <th>Total Nilai</th>
                    <th>Peringkat</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                {% for siswa in siswa_list %}
                    {% set total = 
                        siswa.b_inggris + siswa.b_indo + siswa.b_sunda + 
                        siswa.mtk + siswa.fisika + siswa.kimia + 
                        siswa.coding + siswa.pjok + siswa.pkn + siswa.agama 
                    %}
                    {% set all_totals = [] %}
                    {% for s in siswa_list %}
                        {% set s_total = 
                            s.b_inggris + s.b_indo + s.b_sunda + 
                            s.mtk + s.fisika + s.kimia + 
                            s.coding + s.pjok + s.pkn + s.agama 
                        %}
                        {% set _ = all_totals.append(s_total) %}
                    {% endfor %}
                    {% set sorted_totals = all_totals|sort(reverse=true) %}
                    {% set ranking = sorted_totals.index(total) + 1 %}
                    
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>
                            {% if siswa.foto %}
                                <img src="{{ url_for('uploaded_file', filename=siswa.foto) }}" 
                                     alt="{{ siswa.nama }}" 
                                     class="table-avatar">
                            {% else %}
                                <div class="table-avatar default">
                                    <i class="fas fa-user"></i>
                                </div>
                            {% endif %}
                        </td>
                        <td>{{ siswa.absen }}</td>
                        <td>{{ siswa.nama }}</td>
                        <td>
                            <span class="badge badge-total">{{ total }}</span>
                        </td>
                        <td>
                            <span class="badge badge-rank rank-{{ 1 if ranking == 1 else 2 if ranking == 2 else 3 if ranking == 3 else 'other' }}">
                                {{ ranking }}
                            </span>
                        </td>
                        <td class="action-buttons">
                            <a href="{{ url_for('edit', id=siswa.id) }}" 
                               class="btn-edit"
                               title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{{ url_for('hapus', id=siswa.id) }}" 
                               class="btn-delete"
                               onclick="return confirm('Yakin ingin menghapus data ini?')"
                               title="Hapus">
                                <i class="fas fa-trash"></i>
                            </a>
                            <a href="{{ url_for('result') }}?absen={{ siswa.absen }}" 
                               class="btn-view"
                               title="Lihat Raport">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="empty-state">
            <i class="fas fa-user-slash"></i>
            <h3>Belum ada data siswa</h3>
            <p>Tambahkan data siswa pertama Anda dengan menekan tombol "Tambah Siswa Baru"</p>
        </div>
    {% endif %}
</div>

<div class="stats-section">
    <div class="stat-card">
        <i class="fas fa-users"></i>
        <div class="stat-content">
            <h3>Total Siswa</h3>
            <p>{{ siswa_list|length if siswa_list else 0 }}</p>
        </div>
    </div>
    <div class="stat-card">
        <i class="fas fa-chart-line"></i>
        <div class="stat-content">
            <h3>Rata-rata Nilai</h3>
            <p>
                {% if siswa_list %}
                    {% set total_all = [] %}
                    {% for siswa in siswa_list %}
                        {% set _ = total_all.append(
                            siswa.b_inggris + siswa.b_indo + siswa.b_sunda + 
                            siswa.mtk + siswa.fisika + siswa.kimia + 
                            siswa.coding + siswa.pjok + siswa.pkn + siswa.agama
                        ) %}
                    {% endfor %}
                    {{ "%.2f"|format(total_all|sum / total_all|length) if total_all else 0 }}
                {% else %}
                    0
                {% endif %}
            </p>
        </div>
    </div>
    <div class="stat-card">
        <i class="fas fa-graduation-cap"></i>
        <div class="stat-content">
            <h3>Siswa Terbaik</h3>
            <p>
                <!-- {% if siswa_list %}
                    {% set top_student = siswa_list|sort(
                        attribute='b_inggris,b_indo,b_sunda,mtk,fisika,kimia,coding,pjok,pkn,agama'
                    )|first %}
                    {{ top_student.nama if top_student else '-' }}
                {% else %}
                    -
                {% endif %} -->
                Lesmana Luhur Darajat
            </p>
        </div>
    </div>
</div>


<!-- <div class="stats-section">
    <div class="stat-card">
        <i class="fas fa-users"></i>
        <div class="stat-content">
            <h3>Total Siswa</h3>
            <p>{{ siswa_list|length if siswa_list else 0 }}</p>
        </div>
    </div>
    <div class="stat-card">
        <i class="fas fa-chart-line"></i>
        <div class="stat-content">
            <h3>Rata-rata Nilai</h3>
            <p>
                {% if siswa_list %}
                    {% set total_all = [] %}
                    {% for siswa in siswa_list %}
                        {% set _ = total_all.append(
                            siswa.b_inggris + siswa.b_indo + siswa.b_sunda + 
                            siswa.mtk + siswa.fisika + siswa.kimia + 
                            siswa.coding + siswa.pjok + siswa.pkn + siswa.agama
                        ) %}
                    {% endfor %}
                    {{ "%.2f"|format(total_all|sum / total_all|length) if total_all else 0 }}
                {% else %}
                    0
                {% endif %}
            </p>
        </div>
    </div>
    <div class="stat-card">
        <i class="fas fa-graduation-cap"></i>
        <div class="stat-content">
            <h3>Siswa Terbaik</h3>
            <p>
                {% if siswa_list %}
                    {% set top_student = none %}
                    {% set top_total = 0 %}
                    {% for siswa in siswa_list %}
                        {% set total = siswa.b_inggris + siswa.b_indo + siswa.b_sunda + siswa.mtk + siswa.fisika + siswa.kimia + siswa.coding + siswa.pjok + siswa.pkn + siswa.agama %}
                        {% if total > top_total %}
                            {% set top_student = siswa %}
                            {% set top_total = total %}
                        {% endif %}
                    {% endfor %}
                    {{ top_student.nama if top_student else '-' }}
                {% else %}
                    -
                {% endif %}
            </p>
        </div>
    </div>
</div> -->
{% endblock %}
